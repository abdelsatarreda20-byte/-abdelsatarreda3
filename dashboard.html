// دالة المزامنة الشاملة
function syncData(showLoader = false) {
    if(showLoader) document.getElementById('globalLoader').style.display = 'flex';
    
    // إضافة t= لمنع المتصفح من قراءة البيانات القديمة المخزنة
    fetch(SCRIPT_URL + "?action=getRequests&t=" + new Date().getTime())
    .then(res => res.json())
    .then(data => {
        allData = data;
        renderTable(); // إعادة رسم الجدول بالبيانات الجديدة
        updateStats(data);
        document.getElementById('last-sync').innerText = "تحديث لحظي: " + new Date().toLocaleTimeString('ar-EG');
        if(showLoader) document.getElementById('globalLoader').style.display = 'none';
    });
}

// دالة تحديث الرادار + إرسال إشارة "أنا موجود"
function updateRadar() {
    // السكريبت هيفهم إنك لسه فاتح الصفحة فيسجلك نشط
    fetch(SCRIPT_URL + "?action=getActiveUsers&id=" + currentUser.id + "&t=" + new Date().getTime())
    .then(res => res.json())
    .then(users => {
        const list = document.getElementById('activeUsersList');
        if(users && users.length > 0) {
            list.innerText = users.join(' ، ');
        } else {
            list.innerText = "لا يوجد نشاط خارجي";
        }
    });
}

// تشغيل المنظومة عند فتح الصفحة
window.onload = function() {
    currentUser = JSON.parse(sessionStorage.getItem('shadowUser'));
    if (!currentUser) { window.location.href = "admin.html"; return; }
    
    document.getElementById('uName').innerText = currentUser.name;
    document.getElementById('uRole').innerText = currentUser.role;
    
    if(currentUser.viewActive === "نعم") document.getElementById('radarBox').style.display = 'block';
    if(currentUser.viewExecutor === "نعم") document.getElementById('executorHead').style.display = 'table-cell';

    // 1. تحميل البيانات فوراً
    syncData(true);
    
    // 2. تحديث الجدول "إجبارياً" كل 5 ثواني (عشان تشوف شغل زميلك)
    setInterval(() => {
        syncData(false); 
    }, 5000); 

    // 3. تحديث الرادار كل 10 ثواني
    if(currentUser.viewActive === "نعم") {
        updateRadar(); // تشغيل فوري
        setInterval(updateRadar, 10000); 
    }
};

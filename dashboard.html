<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>غرفة العمليات | لوحة القيادة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #0b1c4d; --gold: #c5a059; --bg: #050a14; --card: #0f172a; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; margin: 0; padding: 20px; }
        
        /* كروت الإحصائيات الحية */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 15px; border-right: 5px solid var(--gold); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .stat-card h3 { margin: 0; color: var(--gold); font-size: 32px; }
        .stat-card p { margin: 5px 0 0; opacity: 0.8; font-size: 14px; }

        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid rgba(197,160,89,0.3); margin-bottom: 25px; }
        
        /* زرار الإجازة */
        .btn-rest { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-rest.active { background: #22c55e; }

        .table-container { background: var(--card); border-radius: 15px; overflow-x: auto; border: 1px solid rgba(197,160,89,0.2); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: rgba(197,160,89,0.1); color: var(--gold); padding: 15px; text-align: center; border-bottom: 2px solid var(--gold); }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* النجمة الذكية للمكرر */
        .star { color: #ffcc00; font-size: 18px; margin-right: 8px; animation: flash 1.5s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        .btn-action { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <h3><i class="fas fa-shield-alt"></i> لوحة قيادة مكتب النائب</h3>
    <div>
        <button id="restBtn" onclick="toggleVacation()" class="btn-rest">تحميل الحالة...</button>
        <button onclick="logout()" style="background:none; color:gray; border:none; cursor:pointer; margin-right:15px;"><i class="fas fa-power-off"></i> خروج</button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card"> <h3 id="totalReq">0</h3> <p>إجمالي الطلبات</p> </div>
    <div class="stat-card" style="border-right-color: #ffcc00;"> <h3 id="duplicateCount">0</h3> <p>مواطنين مكررين ★</p> </div>
    <div class="stat-card" style="border-right-color: #22c55e;"> <h3 id="doneReq">0</h3> <p>تم التنفيذ</p> </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>التاريخ</th>
                <th>الاسم</th>
                <th>الرقم القومي</th>
                <th>تفاصيل الطلب</th>
                <th>المرفق</th>
                <th>الحالة</th>
                <th>الإجراء</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    // الرابط الثابت بتاعك
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxUXcEoNYbit43yl25F8qwJUXMnELDlXx-OwN_q86gotnWWRtR2mUDhhdU92Ypy1wqZtw/exec";

    window.onload = () => {
        if(!sessionStorage.getItem('shadowUser')) { window.location.href="admin.html"; return; }
        checkStatus(); 
        loadData();
    };

    // وظيفة فحص حالة النظام (مفتوح/مغلق)
    function checkStatus() {
        fetch(`${SCRIPT_URL}?action=checkStatus`).then(r => r.json()).then(data => {
            const btn = document.getElementById('restBtn');
            const isClosed = data.status === "closed";
            btn.innerText = isClosed ? "فتح المنصة" : "إدي دماغك إجازة";
            btn.className = isClosed ? "btn-rest active" : "btn-rest";
        });
    }

    // وظيفة زرار الإجازة
    function toggleVacation() {
        const currentBtn = document.getElementById('restBtn');
        const newStatus = currentBtn.innerText.includes("إجازة") ? "closed" : "open";
        let msg = "";
        if(newStatus === "closed") {
            msg = prompt("اكتب رسالة تظهر للمواطنين عند الإغلاق:");
            if(!msg) return; 
        }
        fetch(`${SCRIPT_URL}?action=toggleSystem&status=${newStatus}&msg=${encodeURIComponent(msg)}`)
        .then(() => location.reload());
    }

    // جلب البيانات وعرض النجوم والعدادات
    function loadData() {
        fetch(`${SCRIPT_URL}?action=getRequests`).then(r => r.json()).then(data => {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            let done = 0;
            const idCounts = {};
            // حساب تكرار الرقم القومي
            data.forEach(row => { 
                const id = row[1].toString().trim();
                idCounts[id] = (idCounts[id] || 0) + 1; 
            });

            // حساب عدد الأشخاص المكررين للعداد
            let duplicatesTotal = 0;
            Object.values(idCounts).forEach(v => { if(v > 1) duplicatesTotal++; });
            
            document.getElementById('duplicateCount').innerText = duplicatesTotal;
            document.getElementById('totalReq').innerText = data.length;

            data.forEach(row => {
                const id = row[1].toString().trim();
                const status = row[9] || 'قيد المراجعة';
                if(status === "تم التنفيذ") done++;

                tbody.innerHTML += `<tr>
                    <td>${new Date(row[0]).toLocaleDateString('ar-EG')}</td>
                    <td style="font-weight:bold">
                        ${row[2]} 
                        ${idCounts[id] > 1 ? '<i class="fas fa-star star" title="مواطن مكرر"></i>' : ''}
                    </td>
                    <td>${id}</td>
                    <td>${row[5].substring(0,30)}...</td>
                    <td><a href="${row[7]}" target="_blank" style="color:var(--gold)">فتح المرفق</a></td>
                    <td>${status}</td>
                    <td><button class="btn-action" onclick="updateDecision('${id}')">تحديث</button></td>
                </tr>`;
            });
            document.getElementById('doneReq').innerText = done;
        });
    }

    // تحديث حالة الطلب
    function updateDecision(id) {
        const p = prompt("تحديث حالة الطلب (مثال: تم التنفيذ، مرفوض، جاري العمل):");
        if(p) {
            fetch(`${SCRIPT_URL}?action=updateStatus&id=${id}&status=${encodeURIComponent(p)}`)
            .then(() => loadData());
        }
    }

    function logout() { sessionStorage.clear(); window.location.href="admin.html"; }
</script>
</body>
</html>

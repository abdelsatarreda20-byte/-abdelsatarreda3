<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØºØ±ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª | Ø±ÙØ¬Ø§Ù„ Ø§Ù„Ø¸ÙÙ„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #c5a059; --bg: #050a14; --card: #0f172a; --red: #ef4444; --green: #22c55e; --blue: #3b82f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; margin: 0; padding: 15px; }
        .shadow-header { text-align: center; padding: 10px; border: 2px solid var(--gold); border-radius: 15px; margin-bottom: 20px; background: linear-gradient(to bottom, #0b1c4d, #050a14); }
        .shadow-logo-text { font-size: 30px; color: var(--gold); font-family: 'Amiri', serif; margin: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card); border: 1px solid rgba(197,160,89,0.2); padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .stat-card.active { border-color: var(--gold); background: rgba(197,160,89,0.15); }
        .stat-card p { margin: 5px 0 0; font-size: 28px; font-weight: bold; color: var(--gold); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .btn-system { padding: 10px 18px; border-radius: 8px; border: 1px solid; background: transparent; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; color: white; transition: 0.3s; }
        .btn-off { border-color: var(--red); color: var(--red); }
        .btn-on { border-color: var(--green); color: var(--green); }
        .btn-logout { border-color: #ff4757; color: #ff4757; }
        .main-layout { display: grid; grid-template-columns: 260px 1fr; gap: 15px; }
        .sidebar { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid rgba(197,160,89,0.2); height: fit-content; }
        .online-admin-item { font-size: 13px; padding: 5px 0; border-bottom: 1px solid rgba(197,160,89,0.1); display: flex; align-items: center; justify-content: space-between; }
        .entry-time { font-size: 10px; color: #888; background: #050a14; padding: 2px 5px; border-radius: 4px; }
        .table-container { background: var(--card); border-radius: 12px; overflow-x: auto; border: 1px solid rgba(197,160,89,0.2); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: rgba(197, 160, 89, 0.1); color: var(--gold); padding: 12px; border-bottom: 2px solid var(--gold); }
        td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .online-dot { height: 8px; width: 8px; background-color: var(--green); border-radius: 50%; display: inline-block; margin-left: 8px; box-shadow: 0 0 5px var(--green); }
    </style>
</head>
<body>

<div class="shadow-header"><h1 class="shadow-logo-text">Ø±ÙØ¬Ù€Ø§Ù„ Ø§Ù„Ù€Ø¸ÙÙ€Ù„</h1></div>

<div class="stats-grid">
    <div class="stat-card active" id="stat-all" onclick="updateFilter('all')"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><p id="count-all">0</p></div>
    <div class="stat-card" id="stat-pending" onclick="updateFilter('Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©')"><h3>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯</h3><p id="count-pending" style="color:var(--blue)">0</p></div>
    <div class="stat-card" id="stat-done" onclick="updateFilter('ØªÙ… Ø§Ù„Ø±Ø¯')"><h3>ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</h3><p id="count-done" style="color:var(--green)">0</p></div>
</div>

<div class="top-bar">
    <button id="pwrBtn" class="btn-system" onclick="togglePlatform()"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</button>
    <div style="display:flex; gap:10px;">
        <button class="btn-system" style="border-color:var(--gold)" onclick="loadData()">ØªØ­Ø¯ÙŠØ« <i class="fas fa-sync-alt"></i></button>
        <button class="btn-system btn-logout" onclick="tacticalWithdrawal()">Ø§Ù†Ø³Ø­Ø§Ø¨ ØªÙƒØªÙŠÙƒÙŠ ğŸƒâ€â™‚ï¸</button>
    </div>
</div>

<div class="main-layout">
    <div class="sidebar">
        <input type="text" id="searchInput" onkeyup="renderTable()" class="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø·Ù†...">
        <div style="text-align: center; border-top: 1px solid rgba(197,160,89,0.2); padding-top: 10px;">
            <p style="font-size: 11px; color: #888; margin-bottom: 8px;">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</p>
            <div id="onlineAdminsList" style="color:var(--gold); font-weight: bold;"></div>
        </div>
    </div>
    <div class="table-container">
        <table>
            <thead><tr><th>Ø§Ù„Ù…ÙˆØ§Ø·Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„Ø±Ø¯</th><th>Ø¨ÙˆØ§Ø³Ø·Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxP1k81A9J8vFFf3AKIcwLM8wl5Df63I9U1dQrWqD9pfMp17euQIWkwKr-bJ93eYH8e0w/exec"; 
    
    // Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆØ¬Ù† (shadowUser.role)
    const shadowData = JSON.parse(sessionStorage.getItem('shadowUser') || '{}');
    const CURRENT_USER = shadowData.role || "Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…";
    
    // ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    const loginTime = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

    let allData = [];
    let currentFilter = 'all';

    window.onload = () => {
        updateOnlineStatus();
        checkStatus();
        loadData();
        setInterval(updateOnlineStatus, 30000); 
    };

    function tacticalWithdrawal() {
        if(confirm("ÙŠØ§ ÙˆØ­Ø´ Ù‡ØªÙ…Ø´ÙŠ ÙˆØªØ³ÙŠØ¨Ù†Ø§ØŸ ğŸ˜±")) {
            sessionStorage.clear();
            window.location.href = "admin.html"; 
        }
    }

    function updateOnlineStatus() {
        // Ù†Ø¨Ø¹Øª Ø§Ù„Ø§Ø³Ù… Ù…Ø¹ ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
        const nameWithTime = `${CURRENT_USER} [Ø¯Ø®ÙˆÙ„ ${loginTime}]`;
        fetch(`${SCRIPT_URL}?action=updateOnline&name=${encodeURIComponent(nameWithTime)}`)
        .then(r => r.json())
        .then(admins => {
            const listDiv = document.getElementById('onlineAdminsList');
            listDiv.innerHTML = admins.map(info => {
                // ÙØµÙ„ Ø§Ù„Ø§Ø³Ù… Ø¹Ù† Ø§Ù„ÙˆÙ‚Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø´ÙƒÙ„
                const parts = info.split(' [');
                const name = parts[0];
                const time = parts[1] ? parts[1].replace(']', '') : '';
                return `
                    <div class="online-admin-item">
                        <span><span class="online-dot"></span>${name}</span>
                        <span class="entry-time">${time}</span>
                    </div>`;
            }).join('');
        });
    }

    function checkStatus() {
        fetch(`${SCRIPT_URL}?action=checkStatus`).then(r => r.json()).then(d => {
            const btn = document.getElementById('pwrBtn');
            const isOpen = (d.status === "open");
            btn.innerHTML = isOpen ? '<i class="fas fa-coffee"></i> Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù†ØµØ©' : '<i class="fas fa-bolt"></i> ÙØªØ­ Ø§Ù„Ù…Ù†ØµØ©';
            btn.className = "btn-system " + (isOpen ? "btn-off" : "btn-on");
            window.isPlatformOpen = isOpen;
        });
    }

    function togglePlatform() {
        const action = window.isPlatformOpen ? "closed" : "open";
        const msg = window.isPlatformOpen ? prompt("Ø³Ø¨Ø¨ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:") : "ØªØ¹Ù…Ù„";
        if(msg || !window.isPlatformOpen) {
            fetch(`${SCRIPT_URL}?action=toggleSystem&status=${action}&msg=${encodeURIComponent(msg)}`).then(() => checkStatus());
        }
    }

    function loadData() {
        fetch(`${SCRIPT_URL}?action=getRequests`).then(r => r.json()).then(d => { 
            allData = d.reverse(); 
            calculateStats();
            renderTable(); 
        });
    }

    function calculateStats() {
        document.getElementById('count-all').innerText = allData.length;
        document.getElementById('count-pending').innerText = allData.filter(r => (r[10]||"").includes("Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©")).length;
        document.getElementById('count-done').innerText = allData.filter(r => (r[10]||"").includes("ØªÙ… Ø§Ù„Ø±Ø¯")).length;
    }

    function renderTable() {
        const tb = document.getElementById('tableBody');
        const search = document.getElementById('searchInput').value.toLowerCase();
        let html = "";
        allData.forEach((row, i) => {
            const name = row[3] || ""; 
            const status = row[10] || "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
            const realIdx = (allData.length) - i + 1;
            if ((currentFilter === 'all' || status.includes(currentFilter)) && name.toLowerCase().includes(search)) {
                html += `<tr>
                    <td><b>${name}</b></td>
                    <td><span class="badge ${status.includes('ØªÙ… Ø§Ù„Ø±Ø¯') ? 'badge-done' : 'badge-new'}">${status}</span></td>
                    <td style="color:var(--gold); font-weight:bold;">${row[11] || "-"}</td>
                    <td>
                        <select class="action-select" onchange="applyAction(${realIdx}, this.value)">
                            <option value="">Ø¥Ø¬Ø±Ø§Ø¡</option>
                            <option value="done">ØªÙ… Ø§Ù„Ø±Ø¯</option>
                            <option value="reset">ÙØªØ­</option>
                        </select>
                    </td>
                </tr>`;
            }
        });
        tb.innerHTML = html;
    }

    function applyAction(idx, type) {
        if(!type) return;
        let finalVal = (type === 'done') ? "ØªÙ… Ø§Ù„Ø±Ø¯: " + prompt("Ø§Ù„Ø±Ø¯:") : "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
        if(finalVal.includes("null")) return;
        
        fetch(`${SCRIPT_URL}?action=updateStatus&rowIndex=${idx}&status=${encodeURIComponent(finalVal)}&adminName=${encodeURIComponent(CURRENT_USER)}`)
        .then(() => { alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø³Ù…: " + CURRENT_USER); loadData(); });
    }

    function updateFilter(f) {
        currentFilter = f;
        document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
        document.getElementById(f === 'all' ? 'stat-all' : f === 'ØªÙ… Ø§Ù„Ø±Ø¯' ? 'stat-done' : 'stat-pending').classList.add('active');
        renderTable();
    }
</script>
</body>
</html>

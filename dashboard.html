<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª | Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #0b1c4d; --gold: #c5a059; --bg: #050a14; --card: #0f172a; --green: #22c55e; --blue: #3b82f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid rgba(197,160,89,0.3); margin-bottom: 25px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 15px; border-right: 5px solid var(--gold); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .stat-card h3 { margin: 0; color: var(--gold); font-size: 32px; }
        .stat-card p { margin: 5px 0 0; opacity: 0.8; font-size: 13px; font-weight: bold; }

        .table-container { background: var(--card); border-radius: 15px; overflow-x: auto; border: 1px solid rgba(197,160,89,0.2); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: rgba(197,160,89,0.1); color: var(--gold); padding: 15px; text-align: center; border-bottom: 2px solid var(--gold); }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }
        
        .star { color: #ffcc00; font-size: 14px; margin-right: 5px; animation: flash 1.5s infinite; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .btn-rest { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-rest.active { background: var(--green); }
        .btn-action { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 5px 12px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .btn-action:hover { background: var(--gold); color: white; }
        
        .status-badge { 
            padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; 
            display: inline-block; max-width: 200px; line-height: 1.4;
        }
        .status-msg { background: rgba(197,160,89,0.1); color: var(--gold); border: 1px solid rgba(197,160,89,0.3); }
        .status-new { background: rgba(59, 130, 246, 0.2); color: var(--blue); }

        .admin-stamp { font-size: 11px; color: #888; font-family: 'Courier New', monospace; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <h3><i class="fas fa-shield-alt"></i> ØºØ±ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª Ù…ÙƒØªØ¨ Ø§Ù„Ù†Ø§Ø¦Ø¨ | Ø±Ø¬Ø§Ù„ Ø§Ù„Ø¸Ù„</h3>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span id="welcomeMsg" style="font-size: 13px; color: var(--gold);"></span>
        <button id="restBtn" onclick="toggleVacation()" class="btn-rest">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©...</button>
        <button onclick="logout()" style="background:none; color:gray; border:none; cursor:pointer;"><i class="fas fa-power-off"></i></button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card" style="border-right-color: var(--blue);"> <h3 id="pendingReq">0</h3> <p>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯</p> </div>
    <div class="stat-card" style="border-right-color: var(--green);"> <h3 id="doneReq">0</h3> <p>ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</p> </div>
    <div class="stat-card" style="border-right-color: #ffcc00;"> <h3 id="duplicateCount">0</h3> <p>Ù…ÙˆØ§Ø·Ù†ÙŠÙ† Ù…ÙƒØ±Ø±ÙŠÙ† â˜…</p> </div>
    <div class="stat-card"> <h3 id="totalReq">0</h3> <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p> </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…ÙˆØ§Ø·Ù†</th>
                <th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚</th>
                <th>Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ø±Ø¯</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxP1k81A9J8vFFf3AKIcwLM8wl5Df63I9U1dQrWqD9pfMp17euQIWkwKr-bJ93eYH8e0w/exec";
    
    const userSession = JSON.parse(sessionStorage.getItem('shadowUser'));
    const adminName = userSession ? userSession.name : "Ù…Ø³Ø¤ÙˆÙ„";

    window.onload = () => {
        if(!userSession) { window.location.href="admin.html"; return; }
        document.getElementById('welcomeMsg').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹: " + adminName;
        checkStatus(); 
        loadData();
    };

    // ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø±Ø§Ø± Ø¨ÙƒÙ„Ù…Ø§ØªÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    function checkStatus() {
        fetch(`${SCRIPT_URL}?action=checkStatus`).then(r => r.json()).then(data => {
            const btn = document.getElementById('restBtn');
            btn.innerText = data.status === "closed" ? "Ø´ØºÙ„ Ø§Ù„Ø´ØºÙ„" : "Ø§Ø¯ÙŠ Ø¯Ù…Ø§ØºÙƒ Ø§Ø¬Ø§Ø²Ù‡";
            btn.className = data.status === "closed" ? "btn-rest active" : "btn-rest";
        });
    }

    // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØµØ© (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ)
    function toggleVacation() {
        const btn = document.getElementById('restBtn');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙƒØªÙˆØ¨ "Ø´ØºÙ„ Ø§Ù„Ø´ØºÙ„" ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…Ù†ØµØ© Ù…ØºÙ„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ†Ø±ÙŠØ¯ ÙØªØ­Ù‡Ø§ (open)
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙƒØªÙˆØ¨ "Ø§Ø¯ÙŠ Ø¯Ù…Ø§ØºÙƒ Ø§Ø¬Ø§Ø²Ù‡" ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…Ù†ØµØ© Ù…ÙØªÙˆØ­Ø© ÙˆÙ†Ø±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§ (closed)
        const isCurrentlyClosed = btn.innerText.includes("Ø´ØºÙ„");
        const newStatus = isCurrentlyClosed ? "open" : "closed";
        
        let msg = "";
        if(newStatus === "closed") {
            msg = prompt("Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† (ØªØ¸Ù‡Ø± ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…):");
            if(msg === null) return; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        fetch(`${SCRIPT_URL}?action=toggleSystem&status=${newStatus}&msg=${encodeURIComponent(msg)}`)
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                alert(newStatus === "open" ? "ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´ØºÙ„ Ø¨Ù†Ø¬Ø§Ø­! ğŸš€" : "Ø§Ù„Ù…Ù†ØµØ© Ø£Ø®Ø¯Øª Ø¥Ø¬Ø§Ø²Ø© â˜•");
                checkStatus(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø±Ø§Ø± ÙÙˆØ±Ø§Ù‹ Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©
            }
        })
        .catch(err => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…"));
    }

    function loadData() {
        fetch(`${SCRIPT_URL}?action=getRequests`).then(r => r.json()).then(data => {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let done = 0, pending = 0;
            const idCounts = {};
            
            data.forEach(row => { 
                const id = row[1].toString().trim();
                idCounts[id] = (idCounts[id] || 0) + 1; 
            });

            let duplicates = 0;
            Object.values(idCounts).forEach(v => { if(v > 1) duplicates++; });

            data.forEach((row, index) => {
                const id = row[1].toString().trim();
                const summary = row[5] || '';
                const status = row[9] || 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                const adminStamp = row[10] || '---';
                const rowIndex = index + 2;

                if(status !== "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") done++; else pending++;
                const statusClass = status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" ? "status-new" : "status-msg";

                tbody.innerHTML += `<tr>
                    <td><small>${row[0]}</small></td>
                    <td>
                        <b>${row[2]}</b><br>
                        <small style="opacity:0.6">${id}</small>
                        ${idCounts[id] > 1 ? '<i class="fas fa-star star" title="Ù…ÙˆØ§Ø·Ù† Ù…ÙƒØ±Ø±"></i>' : ''}
                    </td>
                    <td style="text-align:right; max-width: 250px;">
                        <div style="font-size:12px;">${summary}</div>
                    </td>
                    <td><a href="${row[7]}" target="_blank" style="color:var(--gold)"><i class="fas fa-image fa-lg"></i></a></td>
                    <td class="admin-stamp">${adminStamp}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td><button class="btn-action" onclick="updateDecision(${rowIndex})"><i class="fas fa-edit"></i> Ø±Ø¯</button></td>
                </tr>`;
            });
            
            document.getElementById('totalReq').innerText = data.length;
            document.getElementById('duplicateCount').innerText = duplicates;
            document.getElementById('doneReq').innerText = done;
            document.getElementById('pendingReq').innerText = pending;
        });
    }

    function updateDecision(rowIndex) {
        const userMsg = prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù„Ù…ÙˆØ§Ø·Ù† Ø£Ùˆ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
        if (userMsg === null || userMsg.trim() === "") return; 

        fetch(`${SCRIPT_URL}?action=updateStatus&rowIndex=${rowIndex}&status=${encodeURIComponent(userMsg)}&adminName=${encodeURIComponent(adminName)}`)
        .then(res => res.json())
        .then(data => {
            if(data.success) { loadData(); } 
            else { alert("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
        })
        .catch(err => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…"));
    }

    function logout() { sessionStorage.clear(); window.location.href="admin.html"; }
</script>
</body>
</html>

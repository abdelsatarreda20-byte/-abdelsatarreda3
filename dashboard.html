<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØºØ±ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª | Ø±ÙØ¬Ø§Ù„ Ø§Ù„Ø¸ÙÙ„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #c5a059; --bg: #050a14; --card: #0f172a; --red: #ef4444; --green: #22c55e; --blue: #3b82f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; margin: 0; padding: 15px; }
        .shadow-header { text-align: center; padding: 10px; border: 2px solid var(--gold); border-radius: 15px; margin-bottom: 20px; background: linear-gradient(to bottom, #0b1c4d, #050a14); }
        .shadow-logo-text { font-size: 30px; color: var(--gold); font-family: 'Amiri', serif; margin: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card); border: 1px solid rgba(197,160,89,0.2); padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .stat-card.active { border-color: var(--gold); background: rgba(197,160,89,0.15); }
        .stat-card p { margin: 5px 0 0; font-size: 28px; font-weight: bold; color: var(--gold); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .btn-system { padding: 8px 15px; border-radius: 8px; border: 1px solid; background: transparent; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; color: white; transition: 0.3s; font-size: 13px; }
        .btn-off { border-color: var(--red); color: var(--red); }
        .btn-on { border-color: var(--green); color: var(--green); }
        .btn-logout { border-color: #ff4757; color: #ff4757; }
        .main-layout { display: grid; grid-template-columns: 260px 1fr; gap: 15px; }
        .sidebar { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid rgba(197,160,89,0.2); height: fit-content; }
        .search-box { width: 100%; padding: 10px; background: #050a14; border: 1px solid var(--gold); border-radius: 8px; color: white; margin-bottom: 15px; box-sizing: border-box; }
        .online-admin-item { font-size: 13px; padding: 5px 0; border-bottom: 1px solid rgba(197,160,89,0.1); display: flex; align-items: center; justify-content: space-between; }
        .entry-time { font-size: 10px; color: #888; background: #050a14; padding: 2px 5px; border-radius: 4px; }
        .table-container { background: var(--card); border-radius: 12px; overflow-x: auto; border: 1px solid rgba(197,160,89,0.2); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: rgba(197, 160, 89, 0.1); color: var(--gold); padding: 12px; border-bottom: 2px solid var(--gold); }
        td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .online-dot { height: 8px; width: 8px; background-color: var(--green); border-radius: 50%; display: inline-block; margin-left: 8px; box-shadow: 0 0 5px var(--green); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-new { background: rgba(59, 130, 246, 0.2); color: var(--blue); border: 1px solid var(--blue); }
        .badge-done { background: rgba(34, 197, 94, 0.2); color: var(--green); border: 1px solid var(--green); }
        .action-select { background: #1a2236; color: white; border: 1px solid var(--gold); padding: 5px; border-radius: 4px; cursor: pointer; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); margin: 5% auto; padding: 20px; border: 1px solid var(--gold); width: 50%; border-radius: 15px; position: relative; box-shadow: 0 0 20px rgba(197,160,89,0.3); animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; left: 20px; top: 15px; color: var(--gold); font-size: 24px; cursor: pointer; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; text-align: right; }
        .info-item { border-bottom: 1px solid rgba(197,160,89,0.1); padding: 8px 0; }
        .info-label { color: var(--gold); font-size: 12px; display: block; margin-bottom: 4px; }
        .info-value { font-weight: bold; font-size: 15px; color: #fff; line-height: 1.4; }
        .full-width { grid-column: span 2; }
    </style>
</head>
<body>

<div id="previewModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closePreview()">&times;</span>
        <h2 style="color:var(--gold); border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-top:0;">
            <i class="fas fa-id-card"></i> Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
        </h2>
        <div id="modalData" class="info-grid"></div>
    </div>
</div>

<div class="shadow-header"><h1 class="shadow-logo-text">Ø±ÙØ¬Ù€Ø§Ù„ Ø§Ù„Ù€Ø¸ÙÙ€Ù„</h1></div>

<div class="stats-grid">
    <div class="stat-card active" id="stat-all" onclick="updateFilter('all')"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><p id="count-all">0</p></div>
    <div class="stat-card" id="stat-pending" onclick="updateFilter('Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©')"><h3>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯</h3><p id="count-pending" style="color:var(--blue)">0</p></div>
    <div class="stat-card" id="stat-done" onclick="updateFilter('ØªÙ… Ø§Ù„Ø±Ø¯')"><h3>ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</h3><p id="count-done" style="color:var(--green)">0</p></div>
</div>

<div class="top-bar">
    <button id="pwrBtn" class="btn-system" onclick="togglePlatform()"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</button>
    <div style="display:flex; gap:10px;">
        <button class="btn-system" style="border-color:var(--gold)" onclick="loadData()">ØªØ­Ø¯ÙŠØ« <i class="fas fa-sync-alt"></i></button>
        <button class="btn-system btn-logout" onclick="tacticalWithdrawal()">Ø§Ù†Ø³Ø­Ø§Ø¨ ØªÙƒØªÙŠÙƒÙŠ ğŸƒâ€â™‚ï¸</button>
    </div>
</div>

<div class="main-layout">
    <div class="sidebar">
        <input type="text" id="searchInput" onkeyup="renderTable()" class="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø·Ù†...">
        <div style="text-align: center; border-top: 1px solid rgba(197,160,89,0.2); padding-top: 10px;">
            <p style="font-size: 11px; color: #888; margin-bottom: 8px;">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</p>
            <div id="onlineAdminsList" style="color:var(--gold); font-weight: bold;"></div>
        </div>
    </div>
    <div class="table-container">
        <table>
            <thead><tr><th>Ø§Ù„Ù…ÙˆØ§Ø·Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„Ø±Ø¯</th><th>Ø¨ÙˆØ§Ø³Ø·Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxP1k81A9J8vFFf3AKIcwLM8wl5Df63I9U1dQrWqD9pfMp17euQIWkwKr-bJ93eYH8e0w/exec"; 
    
    const shadowData = JSON.parse(sessionStorage.getItem('shadowUser') || '{}');
    const CURRENT_USER = shadowData.role || "Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…";
    const loginTime = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

    let allData = [];
    let currentFilter = 'all';

    window.onload = () => {
        updateOnlineStatus();
        checkStatus();
        loadData();
        setInterval(updateOnlineStatus, 30000); 
    };

    function tacticalWithdrawal() {
        if(confirm("ÙŠØ§ ÙˆØ­Ø´ Ù‡ØªÙ…Ø´ÙŠ ÙˆØªØ³ÙŠØ¨Ù†Ø§ØŸ ğŸ˜±")) {
            sessionStorage.clear();
            window.location.href = "admin.html"; 
        }
    }

    function updateOnlineStatus() {
        const nameWithTime = `${CURRENT_USER} [Ø¯Ø®ÙˆÙ„ ${loginTime}]`;
        fetch(`${SCRIPT_URL}?action=updateOnline&name=${encodeURIComponent(nameWithTime)}`)
        .then(r => r.json())
        .then(admins => {
            const listDiv = document.getElementById('onlineAdminsList');
            listDiv.innerHTML = admins.map(info => {
                const parts = info.split(' [');
                const name = parts[0];
                const time = parts[1] ? parts[1].replace(']', '') : '';
                return `
                    <div class="online-admin-item">
                        <span><span class="online-dot"></span>${name}</span>
                        <span class="entry-time">${time}</span>
                    </div>`;
            }).join('');
        }).catch(e => console.log("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©..."));
    }

    function checkStatus() {
        fetch(`${SCRIPT_URL}?action=checkStatus`).then(r => r.json()).then(d => {
            const btn = document.getElementById('pwrBtn');
            const isOpen = (d.status === "open");
            btn.innerHTML = isOpen ? '<i class="fas fa-coffee"></i> Ø§Ø¯ÙŠ Ø¯Ù…Ø§ØºÙƒ Ø¥Ø¬Ø§Ø²Ø©' : '<i class="fas fa-bolt"></i> ØµØ­ØµØ­ Ù„Ù„Ø¹Ù…Ù„';
            btn.className = "btn-system " + (isOpen ? "btn-off" : "btn-on");
            window.isPlatformOpen = isOpen;
        });
    }

    function togglePlatform() {
        const action = window.isPlatformOpen ? "closed" : "open";
        const msg = window.isPlatformOpen ? prompt("Ø³Ø¨Ø¨ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:") : "ØªØ¹Ù…Ù„";
        if(msg || !window.isPlatformOpen) {
            fetch(`${SCRIPT_URL}?action=toggleSystem&status=${action}&msg=${encodeURIComponent(msg)}`).then(() => checkStatus());
        }
    }

    function loadData() {
        const tb = document.getElementById('tableBody');
        tb.innerHTML = '<tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';
        fetch(`${SCRIPT_URL}?action=getRequests`).then(r => r.json()).then(d => { 
            allData = d.reverse(); 
            calculateStats();
            renderTable(); 
        });
    }

    function calculateStats() {
        document.getElementById('count-all').innerText = allData.length;
        document.getElementById('count-pending').innerText = allData.filter(r => (r[10]||"").includes("Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©")).length;
        document.getElementById('count-done').innerText = allData.filter(r => (r[10]||"").includes("ØªÙ… Ø§Ù„Ø±Ø¯")).length;
    }

    function renderTable() {
        const tb = document.getElementById('tableBody');
        const search = document.getElementById('searchInput').value.toLowerCase();
        let html = "";
        allData.forEach((row, i) => {
            const name = row[3] || ""; 
            const status = row[10] || "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
            const realIdx = (allData.length) - i + 1;
            if ((currentFilter === 'all' || status.includes(currentFilter)) && name.toLowerCase().includes(search)) {
                html += `<tr>
                    <td><b>${name}</b></td>
                    <td><span class="badge ${status.includes('ØªÙ… Ø§Ù„Ø±Ø¯') ? 'badge-done' : 'badge-new'}">${status}</span></td>
                    <td style="color:var(--gold); font-weight:bold;">${row[11] || "-"}</td>
                    <td style="display:flex; gap:5px; justify-content:center;">
                        <button class="btn-system" style="border-color:var(--gold); padding:5px 10px;" onclick="showPreview(${i})">
                            Ù…Ø¹Ø§ÙŠÙ†Ø© <i class="fas fa-eye"></i>
                        </button>
                        <select class="action-select" onchange="applyAction(${realIdx}, this.value)">
                            <option value="">Ø¥Ø¬Ø±Ø§Ø¡</option>
                            <option value="done">ØªÙ… Ø§Ù„Ø±Ø¯</option>
                        </select>
                    </td>
                </tr>`;
            }
        });
        tb.innerHTML = html;
    }

    function showPreview(index) {
        const data = allData[index];
        const modal = document.getElementById('previewModal');
        const container = document.getElementById('modalData');
        
        container.innerHTML = `
            <div class="info-item">
                <span class="info-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø·Ù†:</span>
                <span class="info-value">${data[3] || '-'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</span>
                <span class="info-value">${data[2] || '-'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                <span class="info-value">${data[4] || '-'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</span>
                <span class="info-value">${data[12] || '-'}</span>
            </div>
            <div class="info-item full-width">
                <span class="info-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„:</span>
                <span class="info-value">${data[5] || '-'}</span>
            </div>
            <div class="info-item full-width">
                <span class="info-label">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨:</span>
                <span class="info-value" style="color:var(--gold)">${data[6] || '-'}</span>
            </div>
            <div class="info-item full-width">
                <span class="info-label">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:</span>
                <span class="info-value">
                    ${data[8] ? `<a href="${data[8]}" target="_blank" style="color:var(--blue)">ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚ <i class="fas fa-external-link-alt"></i></a>` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                </span>
            </div>
        `;
        modal.style.display = "block";
    }

    function closePreview() { document.getElementById('previewModal').style.display = "none"; }

    window.onclick = (e) => { if(e.target == document.getElementById('previewModal')) closePreview(); }

    function applyAction(idx, type) {
        if(!type) return;
        let finalVal = "ØªÙ… Ø§Ù„Ø±Ø¯: " + prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ø®ØµØµ:");
        if(finalVal.includes("null") || finalVal === "ØªÙ… Ø§Ù„Ø±Ø¯: ") return;
        
        fetch(`${SCRIPT_URL}?action=updateStatus&rowIndex=${idx}&status=${encodeURIComponent(finalVal)}&adminName=${encodeURIComponent(CURRENT_USER)}`)
        .then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!"); loadData(); });
    }

    function updateFilter(f) {
        currentFilter = f;
        document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
        if(f === 'all') document.getElementById('stat-all').classList.add('active');
        else if(f === 'ØªÙ… Ø§Ù„Ø±Ø¯') document.getElementById('stat-done').classList.add('active');
        else document.getElementById('stat-pending').classList.add('active');
        renderTable();
    }
</script>
</body>
</html>

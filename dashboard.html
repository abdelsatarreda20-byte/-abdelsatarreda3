<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØºØ±ÙØ© Ø¹Ù…Ù„ÙŠØ§Øª | Ø±ÙØ¬Ø§Ù„ Ø§Ù„Ø¸ÙÙ„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #c5a059; --bg: #050a14; --card: #0f172a; --red: #ef4444; --green: #22c55e; --blue: #3b82f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; margin: 0; padding: 15px; }
        .shadow-header { text-align: center; padding: 10px; border: 2px solid var(--gold); border-radius: 15px; margin-bottom: 20px; background: linear-gradient(to bottom, #0b1c4d, #050a14); }
        .shadow-logo-text { font-size: 30px; color: var(--gold); font-family: 'Amiri', serif; margin: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card); border: 1px solid rgba(197,160,89,0.2); padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .stat-card.active { border-color: var(--gold); background: rgba(197,160,89,0.15); }
        .stat-card p { margin: 5px 0 0; font-size: 28px; font-weight: bold; color: var(--gold); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .btn-group { display: flex; gap: 10px; }
        .btn-system { padding: 10px 18px; border-radius: 8px; border: 1px solid; background: transparent; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; color: white; transition: 0.3s; }
        .btn-off { border-color: var(--red); color: var(--red); }
        .btn-on { border-color: var(--green); color: var(--green); }
        .btn-logout { border-color: #ff4757; color: #ff4757; }
        .btn-logout:hover { background: #ff4757; color: white; }
        
        .main-layout { display: grid; grid-template-columns: 260px 1fr; gap: 15px; }
        .sidebar { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid rgba(197,160,89,0.2); height: fit-content; }
        .search-box { width: 100%; padding: 10px; background: #050a14; border: 1px solid var(--gold); border-radius: 8px; color: white; margin-bottom: 15px; box-sizing: border-box; }
        .table-container { background: var(--card); border-radius: 12px; overflow-x: auto; border: 1px solid rgba(197,160,89,0.2); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: rgba(197, 160, 89, 0.1); color: var(--gold); padding: 12px; border-bottom: 2px solid var(--gold); font-size: 14px; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-new { background: rgba(59, 130, 246, 0.2); color: var(--blue); border: 1px solid var(--blue); }
        .badge-done { background: rgba(34, 197, 94, 0.2); color: var(--green); border: 1px solid var(--green); }
        .action-select { background: #1a2236; color: white; border: 1px solid var(--gold); padding: 5px; border-radius: 4px; cursor: pointer; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: var(--card); padding: 25px; border-radius: 15px; border: 2px solid var(--gold); max-width: 450px; width: 90%; }
        .online-dot { height: 8px; width: 8px; background-color: var(--green); border-radius: 50%; display: inline-block; margin-left: 8px; box-shadow: 0 0 5px var(--green); }
    </style>
</head>
<body>

<div id="msgModal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--gold); border-bottom: 1px solid var(--gold); padding-bottom:10px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
        <p id="msgText" style="line-height: 1.6; margin-top: 15px; white-space: pre-wrap;"></p>
        <button onclick="document.getElementById('msgModal').style.display='none'" style="background:var(--gold); border:none; padding:8px 15px; border-radius:5px; cursor:pointer; margin-top:10px; font-weight:bold;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div class="shadow-header">
    <h1 class="shadow-logo-text">Ø±ÙØ¬Ù€Ø§Ù„ Ø§Ù„Ù€Ø¸ÙÙ€Ù„</h1>
</div>

<div class="stats-grid">
    <div class="stat-card active" id="stat-all" onclick="updateFilter('all')">
        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <p id="count-all">0</p>
    </div>
    <div class="stat-card" id="stat-pending" onclick="updateFilter('Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©')">
        <h3>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯</h3>
        <p id="count-pending" style="color:var(--blue)">0</p>
    </div>
    <div class="stat-card" id="stat-done" onclick="updateFilter('ØªÙ… Ø§Ù„Ø±Ø¯')">
        <h3>ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</h3>
        <p id="count-done" style="color:var(--green)">0</p>
    </div>
</div>

<div class="top-bar">
    <button id="pwrBtn" class="btn-system" onclick="togglePlatform()">
        <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...
    </button>
    
    <div class="btn-group">
        <button class="btn-system" style="border-color:var(--gold)" onclick="loadData()">ØªØ­Ø¯ÙŠØ« <i class="fas fa-sync-alt"></i></button>
        <button class="btn-system btn-logout" onclick="tacticalWithdrawal()">Ø§Ù†Ø³Ø­Ø§Ø¨ ØªÙƒØªÙŠÙƒÙŠ ğŸƒâ€â™‚ï¸</button>
    </div>
</div>

<div class="main-layout">
    <div class="sidebar">
        <input type="text" id="searchInput" onkeyup="renderTable()" class="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø·Ù†...">
        <div style="text-align: center; border-top: 1px solid rgba(197,160,89,0.2); padding-top: 10px;">
            <p style="font-size: 11px; color: #888; margin-bottom: 8px;">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</p>
            <div id="onlineAdminsList" style="color:var(--gold); font-weight: bold; font-size: 13px; line-height: 2;">
                </div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…ÙˆØ§Ø·Ù†</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„Ø±Ø¯</th>
                    <th>Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxP1k81A9J8vFFf3AKIcwLM8wl5Df63I9U1dQrWqD9pfMp17euQIWkwKr-bJ93eYH8e0w/exec"; 
    const CURRENT_USER = localStorage.getItem('loggedUser') || "Ù…Ø³Ø¤ÙˆÙ„";

    let allData = [];
    let currentFilter = 'all';
    let isPlatformOpen = true;

    window.onload = () => {
        updateOnlineStatus();
        checkStatus();
        loadData();
        setInterval(updateOnlineStatus, 30000); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
    };

    function tacticalWithdrawal() {
        if(confirm("ÙŠØ§ ÙˆØ­Ø´ Ù‡ØªÙ…Ø´ÙŠ ÙˆØªØ³ÙŠØ¨Ù†Ø§ Ù„Ù„Ø¹ÙƒØŸ ğŸ˜±")) {
            alert("ØªÙ… Ø§Ù„Ù‡Ø±ÙˆØ¨ Ø¨Ù†Ø¬Ø§Ø­.. Ø§Ø®Ù„Ø¹ Ø£Ù†Øª Ø¨Ù‚Ù‰! ğŸƒâ€â™‚ï¸ğŸ’¨");
            localStorage.removeItem('loggedUser');
            window.location.href = "login.html"; // ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… ØµÙØ­Ø© Ø§Ù„Ù„ÙˆØ¬Ù† Ø¹Ù†Ø¯Ùƒ
        }
    }

    function updateOnlineStatus() {
        fetch(`${SCRIPT_URL}?action=updateOnline&name=${encodeURIComponent(CURRENT_USER)}`)
        .then(r => r.json())
        .then(admins => {
            const listDiv = document.getElementById('onlineAdminsList');
            listDiv.innerHTML = admins.map(name => `<div><span class="online-dot"></span>${name}</div>`).join('');
        }).catch(() => {
            document.getElementById('onlineAdminsList').innerHTML = `<div><span class="online-dot"></span>${CURRENT_USER}</div>`;
        });
    }

    function checkStatus() {
        fetch(`${SCRIPT_URL}?action=checkStatus`).then(r => r.json()).then(d => {
            isPlatformOpen = (d.status === "open");
            const btn = document.getElementById('pwrBtn');
            btn.innerHTML = isPlatformOpen ? '<i class="fas fa-coffee"></i> Ø§Ø¯ÙŠ Ø¯Ù…Ø§ØºÙƒ Ø¥Ø¬Ø§Ø²Ø©' : '<i class="fas fa-bolt"></i> ØµØ­ØµØ­ Ù„Ù„Ø¹Ù…Ù„';
            btn.className = "btn-system " + (isPlatformOpen ? "btn-off" : "btn-on");
        });
    }

    function togglePlatform() {
        if(isPlatformOpen) {
            const m = prompt("Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙŠ Ø³ØªØ¸Ù‡Ø± Ù„Ù„Ù†Ø§Ø³:");
            if(m) fetch(`${SCRIPT_URL}?action=toggleSystem&status=closed&msg=${encodeURIComponent(m)}`).then(() => {
                alert("ØªÙ… Ø§Ù„ØªØ´ÙÙŠØ±.. Ø±ÙˆØ­ Ø§ØªØ¹Ø´Ù‰ Ø¨Ù‚Ù‰! ğŸ˜‰");
                checkStatus();
            });
        } else {
            if(confirm("ÙØªØ­ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¢Ù†ØŸ")) fetch(`${SCRIPT_URL}?action=toggleSystem&status=open&msg=ØªØ¹Ù…Ù„`).then(() => checkStatus());
        }
    }

    function loadData() {
        const tb = document.getElementById('tableBody');
        tb.innerHTML = '<tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø£Ø­Ø¯Ø« Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>';
        fetch(`${SCRIPT_URL}?action=getRequests`).then(r => r.json()).then(d => { 
            allData = d.reverse(); 
            calculateStats();
            renderTable(); 
        });
    }

    function calculateStats() {
        const total = allData.length;
        const pending = allData.filter(r => (r[10]||"").includes("Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©")).length;
        const done = allData.filter(r => (r[10]||"").includes("ØªÙ… Ø§Ù„Ø±Ø¯")).length;
        document.getElementById('count-all').innerText = total;
        document.getElementById('count-pending').innerText = pending;
        document.getElementById('count-done').innerText = done;
    }

    function renderTable() {
        const tb = document.getElementById('tableBody');
        const search = document.getElementById('searchInput').value.toLowerCase();
        let html = "";

        allData.forEach((row, i) => {
            const name = row[3] || ""; 
            const status = row[10] || "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
            const realIdx = (allData.length) - i + 1;

            if ((currentFilter === 'all' || status.includes(currentFilter)) && name.toLowerCase().includes(search)) {
                html += `<tr>
                    <td><b>${name}</b></td>
                    <td><span class="badge ${status.includes('ØªÙ… Ø§Ù„Ø±Ø¯') ? 'badge-done' : 'badge-new'}">${status}</span></td>
                    <td style="color:var(--gold); font-size:12px; font-weight:bold;">${row[11] || "-"}</td>
                    <td>
                        <button class="action-select" onclick="showMsg('${(row[6]||"").replace(/'/g, "")}')">Ø¹Ø±Ø¶</button>
                        <select class="action-select" onchange="applyAction(${realIdx}, this.value)">
                            <option value="">Ø¥Ø¬Ø±Ø§Ø¡</option>
                            <option value="done">ØªÙ… Ø§Ù„Ø±Ø¯</option>
                            <option value="reset">ÙØªØ­</option>
                        </select>
                    </td>
                </tr>`;
            }
        });
        tb.innerHTML = html || '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
    }

    function applyAction(idx, type) {
        if(!type) return;
        let finalVal = (type === 'done') ? "ØªÙ… Ø§Ù„Ø±Ø¯" : "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©";
        if(type === 'done') {
            const reply = prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ù…ÙˆØ§Ø·Ù†:");
            if(!reply) return;
            finalVal = "ØªÙ… Ø§Ù„Ø±Ø¯: " + reply;
        }
        fetch(`${SCRIPT_URL}?action=updateStatus&rowIndex=${idx}&status=${encodeURIComponent(finalVal)}&adminName=${encodeURIComponent(CURRENT_USER)}`)
        .then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); loadData(); });
    }

    function updateFilter(f) {
        currentFilter = f;
        document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
        if(f === 'all') document.getElementById('stat-all').classList.add('active');
        else if(f === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©') document.getElementById('stat-pending').classList.add('active');
        else if(f === 'ØªÙ… Ø§Ù„Ø±Ø¯') document.getElementById('stat-done').classList.add('active');
        renderTable();
    }

    function showMsg(t) { document.getElementById('msgText').innerText = t; document.getElementById('msgModal').style.display = 'flex'; }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>غرفة العمليات | النسخة النهائية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #0b1c4d; --gold: #c5a059; --bg: #050a14; --card: #0f172a; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; color: white; margin: 0; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 15px; border-right: 5px solid var(--gold); text-align: center; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid rgba(197,160,89,0.3); margin-bottom: 25px; }
        .table-container { background: var(--card); border-radius: 15px; overflow-x: auto; border: 1px solid rgba(197,160,89,0.2); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: rgba(197,160,89,0.1); color: var(--gold); padding: 15px; border-bottom: 2px solid var(--gold); }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .star { color: #ffcc00; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .btn-rest { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-rest.active { background: #22c55e; }
    </style>
</head>
<body>

<div class="header">
    <h3><i class="fas fa-microchip"></i> نظام إدارة رجال الظل</h3>
    <div>
        <button id="restBtn" onclick="toggleVacation()" class="btn-rest">تحميل...</button>
        <button onclick="logout()" style="background:none; color:gray; border:none; cursor:pointer; margin-right:15px;"><i class="fas fa-sign-out-alt"></i></button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card"><h3 id="totalReq">0</h3><p>إجمالي الطلبات</p></div>
    <div class="stat-card" style="border-right-color: #ffcc00;"><h3 id="dupCount">0</h3><p>مكررين ★</p></div>
    <div class="stat-card" style="border-right-color: #22c55e;"><h3 id="doneReq">0</h3><p>تم التنفيذ</p></div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr><th>التاريخ</th><th>الاسم</th><th>الرقم القومي</th><th>الطلب</th><th>المرفق</th><th>الحالة</th><th>القرار</th><th>بواسطة</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const SCRIPT_URL = "رابط_السكريبت_الخاص_بك"; // حط رابطك هنا

    window.onload = () => { if(!sessionStorage.getItem('shadowUser')) window.location.href="admin.html"; checkStatus(); loadData(); };

    function checkStatus() {
        fetch(`${SCRIPT_URL}?action=checkStatus`).then(r => r.json()).then(data => {
            const btn = document.getElementById('restBtn');
            btn.innerText = data.status === "closed" ? "فتح المنصة" : "إدي دماغك إجازة";
            btn.className = data.status === "closed" ? "btn-rest active" : "btn-rest";
        });
    }

    function toggleVacation() {
        const status = document.getElementById('restBtn').innerText.includes("إجازة") ? "closed" : "open";
        const msg = status === "closed" ? prompt("رسالة الإغلاق:") : "";
        fetch(`${SCRIPT_URL}?action=toggleSystem&status=${status}&msg=${encodeURIComponent(msg)}`).then(() => location.reload());
    }

    function loadData() {
        fetch(`${SCRIPT_URL}?action=getRequests`).then(r => r.json()).then(data => {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            let done = 0, dups = new Set(), seen = new Set();
            data.forEach(row => { if(seen.has(row[1])) dups.add(row[1]); seen.add(row[1]); });
            
            data.forEach(row => {
                if(row[9] === "تم التنفيذ") done++;
                tbody.innerHTML += `<tr>
                    <td>${new Date(row[0]).toLocaleDateString('ar-EG')}</td>
                    <td>${row[2]} ${dups.has(row[1]) ? '<i class="fas fa-star star"></i>' : ''}</td>
                    <td>${row[1]}</td>
                    <td>${row[5].substring(0,20)}...</td>
                    <td><a href="${row[7]}" target="_blank" style="color:var(--gold)">فتح</a></td>
                    <td>${row[9] || 'انتظار'}</td>
                    <td><button onclick="updateStatus('${row[1]}')">تحديث</button></td>
                    <td style="font-size:12px; color:var(--gold)">${row[10] || '-'}</td>
                </tr>`;
            });
            document.getElementById('totalReq').innerText = data.length;
            document.getElementById('dupCount').innerText = dups.size;
            document.getElementById('doneReq').innerText = done;
        });
    }

    function updateStatus(id) {
        const val = prompt("القرار الجديد:");
        const admin = JSON.parse(sessionStorage.getItem('shadowUser')).role;
        if(val) fetch(`${SCRIPT_URL}?action=updateStatus&id=${id}&status=${encodeURIComponent(val)}&admin=${encodeURIComponent(admin)}`).then(() => loadData());
    }
    function logout() { sessionStorage.clear(); window.location.href="admin.html"; }
</script>
</body>
</html>

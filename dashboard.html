<script>
    // الرابط الجديد اللي أنت بعته
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCkgG9dQrSlWi5icGbt-SciYlnDTFj_POdQMM37PiT39YHZCe4WoLBC-I2p5jizAD9Uw/exec";
    let allData = [];
    let currentUser = null;
    let currentFilter = 'all';

    window.onload = function() {
        currentUser = JSON.parse(sessionStorage.getItem('shadowUser'));
        if (!currentUser) { window.location.href = "admin.html"; return; }
        
        document.getElementById('uName').innerText = currentUser.name;
        document.getElementById('uRole').innerText = currentUser.role;
        
        if(currentUser.viewActive === "نعم") document.getElementById('radarBox').style.display = 'block';
        if(currentUser.viewExecutor === "نعم") document.getElementById('executorHead').style.display = 'table-cell';

        syncData(true);
        // التحديث التلقائي كل 3.5 ثانية (المنطقة الآمنة)
        setInterval(() => { syncData(false); }, 3500); 

        if(currentUser.viewActive === "نعم") {
            updateRadar();
            setInterval(updateRadar, 10000);
        }
    };

    function syncData(showLoader = false) {
        if(showLoader) document.getElementById('loader').style.display = 'flex';
        fetch(SCRIPT_URL + "?action=getRequests&t=" + new Date().getTime())
        .then(res => res.json())
        .then(data => {
            allData = data;
            renderTable();
            updateStats(data);
            if(showLoader) document.getElementById('loader').style.display = 'none';
        }).catch(err => {
            console.error("خطأ في المزامنة:", err);
            if(showLoader) document.getElementById('loader').style.display = 'none';
        });
    }

    function renderTable() {
        let displayData = allData;
        if(currentFilter === 'pending') displayData = allData.filter(r => (r[9] || "قيد المراجعة") === "قيد المراجعة");
        if(currentFilter === 'done') displayData = allData.filter(r => r[9] !== "قيد المراجعة" && r[9] !== "");

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        displayData.forEach(row => {
            const tr = document.createElement('tr');
            
            // الترتيب البرمجي للأعمدة (يبدأ من 0):
            // row[0]: التاريخ | row[1]: القومي | row[2]: الاسم | row[5]: اللمحة
            // row[7]: المرفقات (العمود 8) | row[9]: الحالة (العمود 10) | row[10]: بواسطة (العمود 11)

            const statusText = row[9] || "قيد المراجعة";
            const isPending = statusText === "قيد المراجعة";

            tr.innerHTML = `
                <td>${new Date(row[0]).toLocaleDateString('ar-EG')}</td>
                <td style="font-weight:bold">${row[2]}</td> 
                <td title="${row[5]}">${row[5].substring(0,25)}...</td>
                <td>
                    ${row[7] ? `<a href="${row[7]}" target="_blank" style="color:var(--gold)"><i class="fas fa-file-pdf"></i> فتح</a>` : 'لا يوجد'}
                </td>
                <td><span class="status ${isPending ? 'status-pending' : 'status-done'}">${statusText}</span></td>
                ${currentUser.viewExecutor === "نعم" ? `<td style="color:#94a3b8">${row[10] || '---'}</td>` : ''}
                <td><button class="btn-action" onclick="takeAction('${row[1]}')">إجراء</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateStats(data) {
        document.getElementById('totalReq').innerText = data.length;
        document.getElementById('pendingReq').innerText = data.filter(r => (r[9] || "قيد المراجعة") === "قيد المراجعة").length;
        document.getElementById('doneReq').innerText = data.filter(r => r[9] !== "قيد المراجعة" && r[9] !== "").length;
    }

    function setFilter(f) {
        currentFilter = f;
        renderTable();
    }

    function takeAction(id) {
        if(currentUser.canLimit !== "نعم" && currentUser.canGlobal !== "نعم") {
            alert("⚠️ لا تملك صلاحية تعديل القرار"); return;
        }
        const decision = prompt("أدخل حالة الطلب الجديدة (مثلاً: تم الحسم، مرفوض، مستوفى):");
        if(decision && decision.trim() !== "") {
            document.getElementById('loader').style.display = 'flex';
            fetch(`${SCRIPT_URL}?action=updateStatus&id=${id}&status=${decision}&executor=${currentUser.name}`)
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    syncData(true); // تحديث فوري بعد الأكشن
                } else {
                    alert("حدث خطأ أثناء التحديث");
                    document.getElementById('loader').style.display = 'none';
                }
            });
        }
    }

    function updateRadar() {
        fetch(SCRIPT_URL + "?action=getActiveUsers&id=" + currentUser.id + "&t=" + new Date().getTime())
        .then(res => res.json())
        .then(users => {
            const list = document.getElementById('activeUsersList');
            list.innerText = (users && users.length > 0) ? users.join(' ، ') : "لا يوجد نشاط حالي";
        });
    }

    function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
</script>
